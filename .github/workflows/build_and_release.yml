name: Multi-Platform Build & Release

on:
  push:
    branches: [ "main", "dev" ]
    paths:
      - 'lib/**'
      - 'pubspec.yaml'
      - 'windows/**'
      - 'android/**'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # -----------------------------------------------------------------
  # JOB 0: Calculate Version
  # -----------------------------------------------------------------
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.tagger.outputs.tag }}
      is_prerelease: ${{ steps.tagger.outputs.is_prerelease }}
    steps:
      - name: Generate Tag and Name
        id: tagger
        run: |
          DATE=$(date +'%Y.%m.%d')
          SHA_SHORT=$(echo $GITHUB_SHA | cut -c1-7)
          if [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            echo "tag=v${DATE}-dev-${SHA_SHORT}" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "tag=v${DATE}" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

  # -----------------------------------------------------------------
  # JOB 1: Build Android
  # -----------------------------------------------------------------
  build-android:
    needs: get-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'master'
          cache: true
      
      - name: Download Android Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks
      
      - name: Build Android Universal APK
        env:
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: flutter pub get && flutter build apk --release
        
      - name: Rename Artifact
        run: mv build/app/outputs/flutter-apk/app-release.apk FitGirl-Downloader-${{ needs.get-version.outputs.version }}-android-universal.apk

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: FitGirl-Downloader-*.apk

  # -----------------------------------------------------------------
  # JOB 2: Build Linux
  # -----------------------------------------------------------------
  build-linux:
    needs: get-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'master'
          cache: true

      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      - name: Build Linux
        run: flutter pub get && flutter build linux --release

      - name: Compress Build
        run: |
          tar -czvf FitGirl-Downloader-${{ needs.get-version.outputs.version }}-linux-x64.tar.gz -C build/linux/x64/release/bundle .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: FitGirl-Downloader-*.tar.gz

  # -----------------------------------------------------------------
  # JOB 3: Build Windows
  # -----------------------------------------------------------------
  build-windows:
    needs: get-version
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'master'
          cache: true
      
      - name: Build Windows
        run: flutter pub get && flutter build windows --release

      - name: Create Installer (Inno Setup)
        run: |
          choco install innosetup
          iscc windows/installer.iss
          
      - name: Rename Installer
        run: mv build/windows/x64/installer/fitgirl_setup.exe FitGirl-Downloader-${{ needs.get-version.outputs.version }}-windows-setup.exe

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: FitGirl-Downloader-*.exe

  # -----------------------------------------------------------------
  # JOB 4: Build macOS & iOS
  # -----------------------------------------------------------------
  build-apple:
    needs: get-version
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'master'
          cache: true
          
      - run: flutter pub get

      - name: Build macOS
        run: flutter build macos --release

      - name: Compress macOS Build
        run: |
          cd build/macos/Build/Products/Release
          zip -r ../../../../../FitGirl-Downloader-${{ needs.get-version.outputs.version }}-macos-universal.zip .
      
      - name: Build iOS
        run: flutter build ios --release --no-codesign

      - name: Compress iOS Build
        run: |
          cd build/ios/iphoneos
          mkdir Payload
          mv Runner.app Payload/
          zip -r ../../../FitGirl-Downloader-${{ needs.get-version.outputs.version }}-ios-unsigned.ipa Payload

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apple-builds
          path: FitGirl-Downloader-*

  # -----------------------------------------------------------------
  # JOB 5: Create Release
  # -----------------------------------------------------------------
  create-release:
    needs: [get-version, build-android, build-linux, build-windows, build-apple]
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Stage Files
        run: |
          mkdir release_files
          find artifacts/ -type f \( -name "FitGirl-Downloader-*" \) -exec mv {} release_files/ \;

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.get-version.outputs.version }}
          name: Release ${{ needs.get-version.outputs.version }}
          prerelease: ${{ needs.get-version.outputs.is_prerelease }}
          files: release_files/*
        env:
          TOKEN: ${{ secrets.TOKEN }}
